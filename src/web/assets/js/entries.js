var _this3=this,_typeof="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(t){return typeof t}:function(t){return t&&"function"==typeof Symbol&&t.constructor===Symbol&&t!==Symbol.prototype?"symbol":typeof t},WriteNoteWidget=void 0;WriteNoteWidget=Garnish.Base.extend({$widget:null,$btn:null,$list:null,$noteTextarea:null,$spinner:null,modal:null,note:null,entryId:null,init:function(t){this.$widget=$(t),this.$btn=this.$widget.find("#write-note-btn"),this.$list=this.$widget.find(".list"),this.$spinner=this.$widget.find(".loader"),this.entryId=this.$widget.data("entry-id"),this.addListener(this.$btn,"click","openNoteModel")},openNoteModel:function(t){t.preventDefault(),this.modal?(delete this.modal,this.modal=new NoteModal(this)):this.modal=new NoteModal(this),this.modal.on("save",$.proxy(this,"updateNotes"))},updateNotes:function(t){var e=this;this.$spinner.removeClass("hidden"),t={note:this.note,entryId:this.entryId},Craft.postActionRequest("form-builder/notes/save",t,$.proxy(function(t,i){"success"===i&&(Craft.cp.displayNotice(Craft.t("form-builder","Note added")),e.$spinner.addClass("hidden"),e.updateNotesHtml(t.note))},this)),this.modal.hide()},updateNotesHtml:function(t){var e=void 0,i=void 0;i=t.note,e=t.author.fullName,$markup=$('<div class="list-item pad"><div class="item-meta"><span class="item-meta-icon"><i class="far fa-user"></i></span><span class="item-meta-title">'+e+'</span><span class="item-meta-right">'+Craft.t("form-builder","Now")+'</span></div><div class="item-title">'+i+"</div></div>"),this.$list.prepend($markup),$(".no-items").remove()}}),NoteModal=Garnish.Modal.extend({widget:null,init:function(t){var e;this.base(),this.widget=t,this.$form=$('<form class="modal fitted formbuilder-modal">').appendTo(Garnish.$bod),this.setContainer(this.$form),e=$(["<header>",'<span class="modal-title">'+Craft.t("form-builder","Note")+"</span>",'<div class="instructions">'+Craft.t("form-builder","Leave a note for this entry")+"</div>","</header>",'<div class="body">','<div class="fb-field">','<div class="input-hint">TEXT</div>','<div class="input"><textarea id="note-text" rows="6"></textarea></div>',"</div>","</div>",'<footer class="footer">','<div class="buttons">','<input type="button" class="btns btn-modal cancel" value="'+Craft.t("form-builder","Cancel")+'">','<input type="submit" class="btns btn-modal submit" value="'+Craft.t("form-builder","Add")+'">',"</div>","</footer>"].join("")).appendTo(this.$form),this.show(),this.$saveBtn=e.find(".submit"),this.$cancelBtn=e.find(".cancel"),this.$noteTextarea=e.find("#note-text"),this.addListener(this.$cancelBtn,"click","hide"),this.addListener(this.$form,"submit","save")},save:function(t){t.preventDefault(),this.note=this.$noteTextarea.val(),this.widget.note=this.note,""==this.note?Garnish.shake(this.$container):this.trigger("save",{note:this.note})}}),AssetManagement=Garnish.Base.extend({$container:null,$elements:null,$form:null,$trigger:null,downloadCount:null,init:function(t){var e=this;this.$container=$(t),this.$elements=this.$container.find(".item-asset"),this.$form=this.$container.find("#download-all-assets"),this.$trigger=this.$form.find("button"),this.downloadCount=this.$form.find(".asset-count"),this.$status=$(".download-status",this.$form),this.$elements.each(function(t,i){element=new AssetFile(i,e)}),this.addListener(this.$form,"submit","onSubmit")},updateDownloadBtn:function(){items=Object.keys(AssetManagement.storage).length,items>0?(this.downloadCount.html(items),this.$trigger.removeClass("hidden")):(this.$trigger.addClass("hidden"),this.downloadCount.html("0"))},onSubmit:function(t){t.preventDefault(),this.$trigger.hasClass("disabled")||(this.progressBar?this.progressBar.resetProgressBar():this.progressBar=new Craft.ProgressBar(this.$status),this.progressBar.$progressBar.removeClass("hidden"),this.progressBar.$progressBar.velocity("stop").velocity({opacity:1},{complete:$.proxy(function(){var t=Garnish.getPostData(this.$form),e=Craft.expandPostArray(t);e.assets=items=AssetManagement.storage;var i={params:e};Craft.postActionRequest(e.action,i,$.proxy(function(t,e){if("success"===e){if(t&&t.error&&alert(t.error),this.updateProgressBar(),t&&t.downloadFile){var i=$("<iframe/>",{src:Craft.getActionUrl("form-builder/assets/download-file",{filename:t.downloadFile})}).hide();this.$form.append(i)}setTimeout($.proxy(this,"onComplete"),300)}else Craft.cp.displayError(Craft.t("form-builder","There was a problem downloading assets. Please check the Craft logs.")),this.onComplete(!1)},this),{complete:$.noop})},this)}),this.$allDone&&this.$allDone.css("opacity",0),this.$trigger.addClass("disabled"),this.$trigger.trigger("blur"))},updateProgressBar:function(){this.progressBar.setProgressPercentage(100)},onComplete:function(t){this.progressBar.$progressBar.velocity({opacity:0},{duration:"fast",complete:$.proxy(function(){this.$trigger.removeClass("disabled"),this.$trigger.trigger("focus")},this)})}},{storage:{},setStorage:function(t,e,i){var s=arguments.length>3&&void 0!==arguments[3]&&arguments[3];"undefined"==_typeof(AssetManagement.storage[t])&&(AssetManagement.storage[t]={}),s?delete AssetManagement.storage[t]:AssetManagement.storage[t][e]=i},getStorage:function(t,e){return AssetManagement.storage[t]&&AssetManagement.storage[t][e]?AssetManagement.storage[t][e]:null}}),AssetFile=Garnish.Base.extend({element:null,$selectBtn:null,parent:null,id:null,init:function(t,e){this.parent=e,this.element=$(t),this.$selectBtn=this.element.find(".asset-select"),this.id=this.$selectBtn.data("asset-id"),this.addListener(this.$selectBtn,"click","toggleSelection")},toggleSelection:function(){this.$selectBtn.hasClass("active")?(this.$selectBtn.removeClass("active"),this.element.removeClass("selected"),AssetManagement.setStorage(this.id,"asset",this.id,!0)):(this.element.addClass("selected"),this.$selectBtn.addClass("active"),AssetManagement.setStorage(this.id,"asset",this.id)),this.parent.updateDownloadBtn()}}),Garnish.$doc.ready(function(){new WriteNoteWidget(".notes-widget"),new AssetManagement("#main"),Craft.elementIndex&&Craft.elementIndex.on("updateElements",function(t){Craft.postActionRequest("form-builder/entries/get-unread-entries",$.proxy(function(t,e){if(t.success)return window.FormBuilder.unreadCount=t.count,t.count>0?$(".total-entry-count").html(t.count):$(".total-entry-count").html("")},this)),t.target.instanceState.selectedSource,0===t.target.view._totalVisible&&t.target.view.$elementContainer.html($('<tr><td colspan="6">'+Craft.t("form-builder","No entries available")+"</td></tr>")),Craft.postActionRequest("form-builder/entries/get-unread-entries",$.proxy(function(t,e){"success"===e&&($("#sources .entry-count").html(""),$.each(t.grouped,function(t,e){$('[data-key="form:'+t+'"]').find(".entry-count").html(e.length)}),t.totalCount>0?($(".fb-unread-container .fb-badge").addClass("show"),$(".fb-unread-container .fb-badge .count").html(t.totalCount),$("#unread-notifications").find(".body").html(t.template)):($(".fb-unread-container .fb-badge").removeClass("show"),$(".fb-unread-container .fb-badge .count").html(""),$("#unread-notifications").find(".body").html('<p class="no-content">'+Craft.t("form-builder","No unread submissions.")+"</p>")))},this))}),$("#delete-entry").on("click",function(t){var e=$(t.currentTarget).data("entry-id"),i={entryId:e};confirm(Craft.t("form-builder","Deleting entry will remove all relevant assets and notes, are you sure?"))&&Craft.postActionRequest("form-builder/entries/delete",i,$.proxy(function(t,e){"success"===e&&(Craft.cp.displayNotice(Craft.t("form-builder","Deleting entry...")),setTimeout(function(){window.location.href=Craft.getCpUrl()+"/form-builder/entries"},2e3))},_this3))}),$(".submission-action-trigger").on("click",function(t){t.preventDefault();var e=void 0,i=void 0,s=void 0,n=void 0,o=void 0;o=$(this).data("type"),n=$(this).data("form-id"),i=$(this).data("entry-id"),s=$(this).data("file-ids"),e=$('<div class="tout-dropdown"/>').html('<ul class="form-item-menu"></ul>'),"submission"===o?$('<li><a href="#" class="delete-submission">Delete Submission</a></li>').appendTo(e.find("ul")):"form"===o?$('<li><a href="'+window.FormBuilder.adminUrl+"/forms/"+n+'">View Form</a></li>').appendTo(e.find("ul")):"uploads"===o&&($('<li><a href="'+window.FormBuilder.adminUrl+'/entries" class="delete-all-files">Delete All</a></li>').appendTo(e.find("ul")),$('<li><a href="'+window.FormBuilder.adminUrl+'/entries" class="download-all-files">Download All</a></li>').appendTo(e.find("ul"))),new Garnish.HUD($(this),e,{hudClass:"hud fb-hud submissionhud",closeOtherHUDs:!1}),e.find(".delete-submission").on("click",function(t){t.preventDefault();var e=void 0;e={id:i},confirm(Craft.t("form-builder","Are you sure you want to delete this entry?"))&&Craft.postActionRequest("form-builder/entries/delete",e,$.proxy(function(t,e){"success"===e&&(Craft.cp.displayNotice(Craft.t("form-builder","Entry deleted")),window.location.href=window.FormBuilder.adminUrl+"/entries")},this))}),e.find(".delete-all-files").on("click",function(t){var e=void 0;t.preventDefault(),e={fileId:s},confirm(Craft.t("form-builder","Are you sure you want to delete all files?"))&&Craft.postActionRequest("assets/deleteFile",e,$.proxy(function(t,e){var i=void 0;if(t.success){for(i in Garnish.HUD.activeHUDs)Garnish.HUD.activeHUDs[i].hide();return $(".upload-details").parent().velocity("fadeOut",{duration:"100"}),setTimeout(function(){return $(".upload-details").parent().remove()},100)}},this))}),e.find(".download-all-files").on("click",function(t){t.preventDefault();var e=void 0;Craft.cp.displayNotice(Craft.t("form-builder","Downloading...")),e={ids:s,formId:n},Craft.postActionRequest("form-builder/entries/downloadAllFiles",e,$.proxy(function(t,e){var i=void 0,s=void 0;t.success?(window.location="/actions/form-builder/entries/downloadFiles?filePath="+t.filePath,Craft.cp.displayNotice(Craft.t("form-builder","Download Successful"))):Craft.cp.displayError(Craft.t("form-builder",t.message)),s=[];for(i in Garnish.HUD.activeHUDs)s.push(Garnish.HUD.activeHUDs[i].hide());return s},this))})})});